<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Settings — MyCareer</title>
  <style>
    :root {
      --bg:#f6f7fb; --card:#ffffff; --muted:#6b7280; --accent:#2563eb;
      --success:#16a34a; --danger:#dc2626; --radius:12px; --glass: rgba(15,23,42,0.03);
      --maxWidth:1100px; --shadow: 0 10px 30px rgba(2,6,23,0.08); --gap:18px;
    }
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    body{margin:0;background:var(--bg);color:#0f172a;padding:28px;display:flex;justify-content:center;}
    .wrap{width:100%;max-width:var(--maxWidth);}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;gap:12px;}
    .topbar a{color:var(--accent);text-decoration:none;font-weight:700;}
    .layout{display:grid;grid-template-columns:260px 1fr;gap:20px;}
    .sidebar{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;border:1px solid #e6eefc;}
    .profile-box{padding:18px;display:flex;flex-direction:column;align-items:center;gap:12px;border-bottom:1px solid #f1f5f9;}
    .avatar{width:88px;height:88px;border-radius:999px;background:#eef2ff;border:4px solid #e6eefc;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:28px;color:#1e3a8a;overflow:hidden;}
    .avatar img{width:100%;height:100%;object-fit:cover;border-radius:999px;}
    .user-name{font-weight:800;}
    .user-email{font-size:13px;color:var(--muted);}
    .sidebar-nav{display:flex;flex-direction:column;padding:8px;}
    .nav-btn{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-radius:10px;border:1px solid transparent;background:transparent;margin:8px 8px;color:#0f172a;font-weight:700;cursor:pointer;}
    .nav-btn:hover{background:#f8fafc;}
    .nav-btn.active{background:#eef2ff;color:#1e3a8a;border-color:#dbeafe;}
    .sidebar-foot{padding:12px;display:flex;justify-content:center;}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid transparent;cursor:pointer;font-weight:700;}
    .btn.primary{background:var(--accent);color:#fff;}
    .btn.ghost{background:transparent;border-color:#e6eefc;color:#0f172a;}
    .content{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;border:1px solid #e6eefc;}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
    .header h1{font-size:20px;margin:0;}
    .section{display:none;}
    .section.active{display:block;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
    .field{display:flex;flex-direction:column;gap:8px;margin-bottom:10px;}
    label{font-size:13px;color:#0f172a;font-weight:700;}
    input, textarea, select{
      padding:12px 14px;border-radius:10px;border:1px solid #e6eefc;background:#fff;outline:none;font-size:14px;
    }
    textarea{min-height:100px;resize:vertical;}
    .muted{color:var(--muted);font-size:13px; padding-left: 25px;}
    .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px;}
    @media (max-width:980px){ .layout{grid-template-columns:1fr;} .grid{grid-template-columns:1fr;} .sidebar{order:2} .content{order:1} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div><a href="index.html">← Home</a></div>
      <div><a id="signOutTop" href="#" style="color:var(--accent);font-weight:700">Sign out</a></div>
    </div>

    <div class="layout">
      <!-- SIDEBAR -->
      <aside class="sidebar">
        <div class="profile-box">
          <div id="sidebarAvatar" class="avatar">U</div>
          <div style="text-align:center">
            <div id="sidebarName" class="user-name">User</div>
            <div id="sidebarEmail" class="user-email">email@example.com</div>
          </div>
        </div>

        <nav class="sidebar-nav">
          <button class="nav-btn active" data-target="account">Account</button>
          <button class="nav-btn" data-target="profile">Profile</button>
          <button class="nav-btn" data-target="security">Security</button>
        </nav>

        <div class="sidebar-foot">
          <button id="saveAllBtn" class="btn primary">Save All</button>
        </div>
      </aside>

      <!-- CONTENT -->
      <main class="content">
        <div class="header">
          <h1>Settings</h1>
          <div class="muted">Manage your account, profile and security settings</div>
        </div>

        <section id="account" class="section active">
          <h3>Account</h3>
          <div class="grid">
            <div>
              <div class="field">
                <label for="accName">Full name</label>
                <input id="accName" type="text" placeholder="Your full name" />
                <div class="counter" id="nameCount">0 / 80</div>
              </div>

              <div class="field">
                <label for="accEmail">Email</label>
                <input id="accEmail" type="email" placeholder="you@example.com" />
              </div>

              <div class="field">
                <label for="accPhone">Phone</label>
                <input id="accPhone" type="tel" placeholder="+92 300 1234567" />
              </div>
            </div>

            <div>
              <div class="field">
                <label>Avatar</label>
                <div class="avatar-edit">
                  <div id="accAvatar" class="avatar">U</div>
                  <div style="display:flex;gap:8px">
                    <input id="avatarInput" type="file" accept="image/*" style="display:none" />
                    <button id="changeAvatar" class="btn ghost small">Change</button>
                    <button id="removeAvatar" class="btn ghost small">Remove</button>
                  </div>
                </div>
              </div>

              <div class="field">
                <label for="roleSelect">Role</label>
                <select id="roleSelect">
                  <option value="">Select role</option>
                  <option>Student</option>
                  <option>Developer</option>
                  <option>Designer</option>
                  <option>Hiring Manager</option>
                  <option>Other</option>
                </select>
              </div>
            </div>
          </div>

          <div class="actions">
            <button id="saveAccount" class="btn primary">Save account</button>
            <button id="cancelAccount" class="btn ghost">Cancel</button>
          </div>
        </section>

        <!-- PROFILE -->
        <section id="profile" class="section">
          <h3>Profile</h3>
          <div class="grid">
            <div>
              <div class="field">
                <label for="bio">Bio / Tagline</label>
                <textarea id="bio" placeholder="Describe yourself in a sentence..."></textarea>
                <div class="counter" id="bioCount">0 / 160</div>
              </div>

              <div class="field">
                <label for="pronouns">Pronouns</label>
                <input id="pronouns" type="text" placeholder="e.g. he/him" />
              </div>

              <div class="field">
                <label for="occupation">Occupation</label>
                <input id="occupation" type="text" placeholder="e.g. Student, Software Engineer" />
              </div>
            </div>

            <div>
              <div class="field">
                <label for="organization">Organization</label>
                <input id="organization" type="text" placeholder="Company / University" />
              </div>

              <div class="field">
                <label for="location">Location</label>
                <input id="location" type="text" placeholder="City, Country" />
              </div>

              <div class="field">
                <label for="website">Website / Portfolio</label>
                <input id="website" type="text" placeholder="https://your.site" />
              </div>
            </div>
          </div>

          <div class="actions">
            <button id="saveProfile" class="btn primary">Save profile</button>
            <button id="cancelProfile" class="btn ghost">Cancel</button>
          </div>
        </section>

        <!-- SECURITY -->
        <section id="security" class="section">
          <h3>Security</h3>
          <div class="field">
            <label for="curPwd">Current password</label>
            <input id="curPwd" type="password" placeholder="Current password" />
          </div>

          <div class="grid">
            <div class="field">
              <label for="newPwd">New password</label>
              <input id="newPwd" type="password" placeholder="New password (min 6 char)" />
            </div>
            <div class="field">
              <label for="newPwd2">Confirm new password</label>
              <input id="newPwd2" type="password" placeholder="Confirm new password" />
            </div>
          </div>

          <div class="field">
            <label for="recoveryEmail">Recovery email (optional)</label>
            <input id="recoveryEmail" type="email" placeholder="recovery@example.com" />
          </div>

          <div class="actions">
            <button id="changePassword" class="btn primary">Change password</button>
            <button id="cancelSecurity" class="btn ghost">Cancel</button>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBAj2SLWwMSBDB4jl0VLjVhea9W6FkhXF0",
      authDomain: "my-career-project-a1885.firebaseapp.com",
      projectId: "my-career-project-a1885",
      storageBucket: "my-career-project-a1885.firebasestorage.app",
      messagingSenderId: "1006665032949",
      appId: "1:1006665032949:web:175f91f2559139cda8d1bc"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const qs = s => document.querySelector(s);
    const qsa = s => document.querySelectorAll(s);

    function getCurrentEmail(){ return localStorage.getItem('currentUserEmail'); }
    function setCurrentEmail(e){ localStorage.setItem('currentUserEmail', e); }
    function isLoggedIn(){ return localStorage.getItem('loggedIn') === 'true' && !!getCurrentEmail(); }

    if(!isLoggedIn()){ alert('Please login/register first.'); window.location.href = 'login.html'; }

    let currentUserData = {};
    let currentUserDocId = null;

    const navBtns = Array.from(qsa('.nav-btn'));
    const sections = Array.from(qsa('.section'));

    navBtns.forEach(btn => btn.addEventListener('click', ()=>{
      navBtns.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      sections.forEach(s=>s.classList.remove('active'));
      qs('#'+btn.dataset.target).classList.add('active');
    }));

    function bindCount(inputId,countId,max){
      const el = qs('#'+inputId);
      const counter = qs('#'+countId);
      const update=()=>{const v=el.value||'';counter.textContent=`${v.length} / ${max}`;};
      el.addEventListener('input',update);update();
    }
    bindCount('accName','nameCount',80);
    bindCount('bio','bioCount',160);

    async function loadUI(){
      const email = getCurrentEmail();
      try{
        const qSnap = await getDocs(query(collection(db,"users"),where("email","==",email)));
        if(!qSnap.empty){
          qSnap.forEach(docSnap=>{
            currentUserData = docSnap.data();
            currentUserDocId = docSnap.id;
          });
        }
        qs('#accName').value = currentUserData.name || '';
        qs('#accEmail').value = currentUserData.email || email;
        qs('#accPhone').value = currentUserData.phone || '';
        qs('#roleSelect').value = currentUserData.role || '';
        qs('#bio').value = currentUserData.bio || '';
        qs('#pronouns').value = currentUserData.pronouns || '';
        qs('#occupation').value = currentUserData.occupation || '';
        qs('#organization').value = currentUserData.organization || '';
        qs('#location').value = currentUserData.location || '';
        qs('#website').value = currentUserData.website || '';
        qs('#recoveryEmail').value = currentUserData.recoveryEmail || '';
        qs('#sidebarName').textContent = currentUserData.name || 'User';
        qs('#sidebarEmail').textContent = currentUserData.email || email;
      }catch(err){console.error(err);}
    }

    qs('#signOutTop').addEventListener('click',e=>{
      e.preventDefault();
      localStorage.setItem('loggedIn','false');
      localStorage.removeItem('currentUserEmail');
      alert('Signed out.');
      window.location.href='index.html';
    });

    async function saveAccount(){
      const name = qs('#accName').value.trim();
      const email = qs('#accEmail').value.trim();
      const phone = qs('#accPhone').value.trim();
      const role = qs('#roleSelect').value;
      if(!name||!email){alert('Name and Email required');return;}
      if(currentUserDocId){
        await updateDoc(doc(db,'users',currentUserDocId),{name,email,phone,role});
        setCurrentEmail(email);
        alert('Account updated!');
        loadUI();
      }
    }

    async function saveProfile(){
      if(currentUserDocId){
        await updateDoc(doc(db,'users',currentUserDocId),{
          bio:qs('#bio').value.trim(),
          pronouns:qs('#pronouns').value.trim(),
          occupation:qs('#occupation').value.trim(),
          organization:qs('#organization').value.trim(),
          location:qs('#location').value.trim(),
          website:qs('#website').value.trim(),
          recoveryEmail:qs('#recoveryEmail').value.trim()
        });
        alert('Profile updated!');
        loadUI();
      }
    }

    async function changePassword(){
      const np=qs('#newPwd').value;
      const np2=qs('#newPwd2').value;
      const cur=qs('#curPwd').value;
      if(np!==np2){alert('Passwords do not match');return;}
      if(np.length<6){alert('Password too short');return;}
      if(currentUserData.password && cur!==currentUserData.password){alert('Wrong current password');return;}
      await updateDoc(doc(db,'users',currentUserDocId),{password:np});
      alert('Password changed!');
      qs('#curPwd').value=qs('#newPwd').value=qs('#newPwd2').value='';
    }

    qs('#saveAccount').onclick=saveAccount;
    qs('#saveProfile').onclick=saveProfile;
    qs('#changePassword').onclick=changePassword;
    qs('#cancelAccount').onclick=loadUI;
    qs('#cancelProfile').onclick=loadUI;
    qs('#cancelSecurity').onclick=()=>{qs('#curPwd').value=qs('#newPwd').value=qs('#newPwd2').value='';};
    qs('#saveAllBtn').onclick=async()=>{await saveAccount();await saveProfile();alert('All changes saved!');};

    loadUI();
  </script>
</body>
</html>
